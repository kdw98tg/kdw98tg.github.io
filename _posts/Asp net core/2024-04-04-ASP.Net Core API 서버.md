---
title: "[ASP.NET Core] ASP.Net CORE ë¥¼ í™œìš©í•´ì„œ API ì„œë²„ êµ¬ì¶•í•˜ê¸°"

categories:
  -  ASP .NET Core
  
tags:
  - [Web, ASP.NET Core, Unity, C#]

toc: true
toc_sticky: true

published: true

date: 2024-04-04
last_modified_at: 2024-04-04
---

ì´ì „ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì„œë²„ì‚¬ì´ë“œ PHPë¥¼ ì‚¬ìš©í•˜ì—¬ Http í†µì‹ ì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” ASP.NET Coreë¥¼ ì‚¬ìš©í•˜ì—¬ API ì„œë²„ë¥¼ ë§Œë“¤ì–´ì„œ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ê³  í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

í˜„ì¬ëŠ” ë™ì‘ì´ë˜ê³ , CRUD ê°€ ë˜ëŠ” ê¸°ë³¸ì ì¸ ìƒíƒœì…ë‹ˆë‹¤.  


## DataBaseì™€ ì—°ê²°

ASP.NET Coreì—ì„œ DBì™€ ì—°ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì„¸íŒ…ì„ í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

### appsettings.json

ìš°ì„ , ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ì˜ `Connection String`ì„ ê¸°ì…í•©ë‹ˆë‹¤.
```js
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "MySqlServer": "your_database_string"
  }
}
```

### Program.cs
`appsettings.json`ì„ ê¸°ì…í•˜ì˜€ë‹¤ë©´, `Program.cs` ìŠ¤í¬ë¦½íŠ¸ë¡œ ì™€ì„œ DB ì—°ê²° ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

í•´ë‹¹ ì½”ë“œë¥¼ ì‚½ì…í•˜ë©´, ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ì™€ ì—°ê²°ì´ ì™„ë£Œ ë©ë‹ˆë‹¤ .
```cs
builder.Services.AddDbContext<MySqlContext>
    (options => options.UseMySql(builder.Configuration.GetConnectionString("MySqlServer"),
        ServerVersion.AutoDetect(builder.Configuration.GetConnectionString("MySqlServer")))
    );
```


### Model í´ë˜ìŠ¤ ë§Œë“¤ê¸°

ì´ì œ ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸”ê³¼ ë§¤í•‘ë˜ëŠ” `Model`í´ë˜ìŠ¤ë¥¼ ë§Œë“­ë‹ˆë‹¤.
ì´ í´ë˜ìŠ¤ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸”ì— ìˆëŠ” ì»¬ëŸ¼ê³¼ ê°™ê²Œ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
ëŒ€ì†Œë¬¸ìëŠ” êµ¬ë¶„í•˜ì§€ ì•Šì§€ë§Œ, ì´ë¦„ì´ ë‹¤ë¥´ë©´ ì¸ì‹í•˜ì§€ ëª»í•˜ë‹ˆ ê·¸ì ì„ ì£¼ì˜í•©ë‹ˆë‹¤.

ğŸ—… **<span style="color: #c03a92">class User</span>**
```cs
using System.ComponentModel.DataAnnotations;

namespace MyApi.Models
{
    public class User
    {
        [Key]
        public int Id { get; set; }

        [StringLength(255)]
        public  string? UserName { get; set; }

        [Phone]
        public string? phone_number {  get; set; }

        [Range(1,100)]
        public int? Age { get; set; }
    }
}
```

### Context
ì´ì œ í•´ë‹¹ DBì˜ `Context`ë¥¼ ê°€ì ¸ì™€ì„œ, í…Œì´ë¸”ê³¼ ë§¤í•‘í•©ë‹ˆë‹¤.
í˜„ì¬ ì €ëŠ” `user` í…Œì´ë¸”ê³¼ `test`í…Œì´ë¸” ë‘ê°€ì§€ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ ë†¨ìŠµë‹ˆë‹¤.
í•´ë‹¹ Context ì•ˆì— `User`ì™€ `TestItem` ì„ ë„£ì–´ í…Œì´ë¸”ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.

ğŸ—… **<span style="color: #c03a92">class MySqlContext</span>**
```cs
using Microsoft.EntityFrameworkCore;

namespace MyApi.Models
{
    public class MySqlContext:DbContext
    {
        public MySqlContext(DbContextOptions<MySqlContext> options): base(options)
        {

        }
        public DbSet<User> User { get; set; } = null!;
        public DbSet<TestItem> Test { get; set; } = null!;
    }
}
```


### Controller

ì´ì œ `Controller`ë¥¼ ë§Œë“¤ì–´ ì‹¤ì œ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ëŠ” ë¡œì§ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

`Controller`ì—ì„œëŠ” ì¼ë°˜ `Model`í´ë˜ìŠ¤ë¥¼ ë°”ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, `DTO(Data Transfer Object)` ë¥¼ ë§Œë“¤ì–´ì„œ, í•„ìš”í•œ ì •ë³´ë§Œ ë‹´ì•„ì„œ ë³´ëƒ…ë‹ˆë‹¤.

ğŸ—… **<span style="color: #c03a92">class UserDTO</span>**
```cs
using System.ComponentModel.DataAnnotations;

namespace MyApi.Models
{
    public class UserDTO
    {

        [Key]
        public int Id { get; set; }

        [StringLength(255)]
        public string? UserName { get; set; }

        [Phone]
        public string? phone_number { get; set; }

        [Range(1, 100)]
        public int? Age { get; set; }
    }
}
```

DTOë¥¼ ë§Œë“¤ì—ˆë‹¤ë©´, Controllerì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

`Restful API`ì— ë§ê²Œ `Get`, `Post`, `Put`, `Patch`, `Delte` ë©”ì„œë“œë¥¼ ë§Œë“­ë‹ˆë‹¤.

ğŸ—… **<span style="color: #c03a92">class UserController</span>**
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using TodoApi.Models;

namespace MyApi.Controllers
{
    [Route("api/users")]
    [ApiController]
    public class UserController : ControllerBase
    {
        private readonly MySqlContext context;

        public UserController(MySqlContext context)
        {
            this.context = context;
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<UserDTO>>> GetUsers()
        {
            try
            {
                return await context.User.Select(x => ItemToDTO(x)).ToListAsync();
            }
            catch (Exception ex)
            {
                return BadRequest(ex.Message);
            }
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<UserDTO>> GetUser(int id)
        {
            try
            {
                var user = await context.User.FindAsync(id);

                if (user == null)
                {
                    return NotFound();
                }

                return ItemToDTO(user);
            }
            catch (Exception ex)
            {
                return BadRequest(ex.Message);
            }
        }

        [HttpPut("id")]
        public async Task<IActionResult> PutUser(int id, UserDTO userDTO)
        {

            if (id != userDTO.Id)
            {
                return BadRequest();
            }

            var user = await context.User.FindAsync(id);

            if (user == null)
            {
                return NotFound();
            }

            user.UserName = userDTO.UserName;
            user.phone_number = userDTO.phone_number;
            user.Age = userDTO.Age;

            try
            {
                await context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException) when (!TodoItemExists(id))
            {
                return NotFound();
            }

            return NoContent();
        }

        [HttpPost]
        public async Task<IActionResult> PostUser(UserDTO userDTO)
        {
            try
            {
                var user = new User
                {
                    UserName = userDTO.UserName,
                    phone_number = userDTO.phone_number,
                    Age = userDTO.Age,
                };

                context.User.Add(user);
                await context.SaveChangesAsync();

                return CreatedAtAction(nameof(GetUser), new { id = user.Id }, ItemToDTO(user));
            }
            catch (Exception ex)
            {
                // ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ BadRequest ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤.
                return BadRequest(ex.Message);
            }
        }

        [HttpPatch("{id}")]
        public async Task<ActionResult<UserDTO>> PatchUser(int id, UserDTO userDTO)
        {
            try
            {
                var user = await context.User.FindAsync(id);
                if (user == null)
                {
                    return NotFound();
                }
                user.UserName = userDTO.UserName;
                user.phone_number = userDTO.phone_number;
                user.Age = userDTO.Age;

                await context.SaveChangesAsync();

                return CreatedAtAction(nameof(GetUser), new { id = user.Id }, ItemToDTO(user));
            }
            catch (Exception ex)
            {
                return BadRequest(ex.Message);
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteTodoItem(int id)
        {
            try
            {

                var user = await context.User.FindAsync(id);
                if (user == null)
                {
                    return NotFound();
                }
                context.User.Remove(user);
                await context.SaveChangesAsync();

                return NoContent();
            }
            catch (Exception ex)
            {
                return BadRequest(ex.Message);
            }

        }

        private bool TodoItemExists(long id)
        {
            return context.User.Any(e => e.Id == id);
        }

        private static UserDTO ItemToDTO(User todoItem) =>
            new UserDTO()
            {
                Id = todoItem.Id,
                UserName = todoItem.UserName,
                phone_number = todoItem.phone_number,
                Age = todoItem.Age
            };
    }
}
```

ì´ë ‡ê²Œ í•˜ë©´, Swagger ë¥¼ í†µí•´ ë¬¸ì„œí™”ëœ API ì„œë²„ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Swagger API](/images/Pasted%20image%2020240409151438.png)

### Unity Client

ì œê°€ì„¤ì •í•œ ë¼ìš°íŒ… ê²½ë¡œë¡œ ì ‘ê·¼í•˜ë©´ ì •ë³´ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ”ì§€ í…ŒìŠ¤íŠ¸ í•˜ëŠ”  Unity Client ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

ì „ì²´ì½”ë“œëŠ” ì €ë²ˆì— ì‘ì„±í•˜ì˜€ë˜ PHPë¥¼ í™œìš©í•œ HTTP í†µì‹  í¬ìŠ¤íŒ…ì— ìˆëŠ” ì½”ë“œì™€ ê±°ì˜ ë™ì¼ í•©ë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” `Post` ì½”ë“œë§Œ í¬ìŠ¤íŒ… í•˜ê² ìŠµë‹ˆë‹¤.

```cs
 //Post == Insert
 public IEnumerator PostTodoItem(TodoItemDTO _item, Action<bool, TodoItemDTO> _action)
 {
     string itemJson = JsonUtility.ToJson(_item);
     byte[] jsonToSend = new UTF8Encoding().GetBytes(itemJson);

     UnityWebRequest request = new UnityWebRequest(url, "POST");
     request.uploadHandler = new UploadHandlerRaw(jsonToSend);
     request.downloadHandler = new DownloadHandlerBuffer();
     request.SetRequestHeader("Content-Type", "application/json");

     yield return request.SendWebRequest();
     try
     {
         if (request.result == UnityWebRequest.Result.ConnectionError ||
             request.result == UnityWebRequest.Result.ProtocolError)
         {
             _action(false, null);
         }
         else
         {
             Debug.Log("Received: " + request.downloadHandler.text);

             JObject jsonResponse = JObject.Parse(request.downloadHandler.text);

             long userID = method.ParseLongOrDefault(jsonResponse["id"].ToString());
             string userName = method.CheckNull(jsonResponse["name"].ToString());
             string isComplete = method.CheckNull(jsonResponse["isComplete"].ToString());

             TodoItemDTO todoItemDTO = new TodoItemDTO(userID, userName, isComplete);

             _action(true, todoItemDTO);
         }
     }
     catch (Exception ex)
     {
         //ë¡œê¹…ì‘ì—…
         _action(false, null);
     }
 }
```

`Post`ëŠ” ë‚´ìš©ì„ ë°›ì•„ ì„œë²„ì— ì €ì¥í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.